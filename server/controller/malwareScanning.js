const axios = require('axios');
const FormData = require('form-data');
require('dotenv').config({ path: '../.env' });

const API_KEY = process.env.API_KEY;
const BASE_URL = process.env.BASE_URL;


async function scanFile(fileBuffer) {
    const form = new FormData();
    form.append('file', fileBuffer, { filename: 'file.pdf', contentType: 'application/pdf' });

    // console.log('Scanning with MetaDefender. API Key:', API_KEY ? 'Set' : 'Missing');
    try {
        const response = await axios.post(`${BASE_URL}/file`, form, {
            headers: {
                'apikey': API_KEY,
                ...form.getHeaders()
            }
        });
        // console.log('MetaDefender response:', response.data);
        return { dataId: response.data.data_id };
    } catch (error) {
        // console.error('MetaDefender error:', {
        //     message: error.message,
        //     status: error.response?.status,
        //     data: error.response?.data
        // });
        throw new Error(error.response?.data?.error?.message || error.message);
    }
}


async function getReport(scanId) {
    // console.log('Fetching report for scanId:', scanId);
    try {
        const response = await axios.get(`${BASE_URL}/file/${scanId}`, {
            headers: { 'apikey': API_KEY }
        });
        // console.log('MetaDefender report:', response.data);
        return response.data;
    } catch (error) {
        console.error('Get report error:', error.message, error.response?.data);
        throw new Error(error.response?.data?.error?.message || error.message);
    }
}



module.exports = { scanFile , getReport }; 
  